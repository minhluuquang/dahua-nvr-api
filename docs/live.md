# Live Streaming

This document covers live streaming via RTSP-over-WebSocket and HLS playback.

## Overview

The API supports two live streaming paths:

- RTSP-over-WebSocket for raw interleaved RTP packets.
- HLS for browser-friendly playback (FFmpeg-backed).

## RTSP-over-WebSocket

### Start Stream

**Endpoint:** `POST /api/streams/start`

**Request Body:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `session` | string | Yes | Session ID from login |
| `channel` | number | Yes | Camera channel number |
| `subtype` | number | No | Stream subtype (`0` main, `1` sub) |

**Example Request:**

```bash
curl -X POST http://localhost:3000/api/streams/start \
  -H "Content-Type: application/json" \
  -d '{
    "session": "YOUR_SESSION_ID",
    "channel": 1,
    "subtype": 0
  }'
```

**Example Response:**

```json
{
  "success": true,
  "streamId": "stream-id",
  "wsUrl": "ws://localhost:3000/api/streams/stream-id/ws"
}
```

### WebSocket Stream

Connect to `wsUrl` and receive raw interleaved RTP packets (leading `$` byte).

### Stop Stream

**Endpoint:** `POST /api/streams/{id}/stop`

**Example Request:**

```bash
curl -X POST http://localhost:3000/api/streams/stream-id/stop
```

## HLS Playback (Browser)

HLS is generated by FFmpeg and exposed as a playlist and segments.

### Start HLS Stream

**Endpoint:** `POST /api/streams/hls/start`

**Request Body:**

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `session` | string | Yes | Session ID from login |
| `channel` | number | Yes | Camera channel number |
| `subtype` | number | No | Stream subtype (`0` main, `1` sub) |
| `rtspPort` | number | No | RTSP port override (example: `80` or `554`) |

**Example Request:**

```bash
curl -X POST http://localhost:3000/api/streams/hls/start \
  -H "Content-Type: application/json" \
  -d '{
    "session": "YOUR_SESSION_ID",
    "channel": 1,
    "subtype": 0,
    "rtspPort": 80
  }'
```

**Example Response:**

```json
{
  "success": true,
  "streamId": "hls-stream-id",
  "playlistUrl": "http://localhost:3000/api/streams/hls/hls-stream-id/index.m3u8"
}
```

### Built-in Player

Open the player page in your browser:

```
http://localhost:3000/player/hls/{streamId}
```

Safari uses native HLS; Chrome/Firefox uses hls.js.

### Stop HLS Stream

**Endpoint:** `POST /api/streams/hls/{id}/stop`

```bash
curl -X POST http://localhost:3000/api/streams/hls/hls-stream-id/stop
```

## Testing Scripts

### HLS Smoke Test

`scripts/test-hls.js` logs in, starts HLS for channel 1, and waits for the playlist.

```bash
node scripts/test-hls.js
```

Optional overrides:

```bash
node scripts/test-hls.js http://localhost:3000 http://cam.lab
```
