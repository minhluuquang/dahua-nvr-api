# AGENTS.md

Purpose: give coding agents a fast, accurate guide for this repo.
Keep changes small, consistent, and TypeScript-first.

## Project Summary
- Runtime: Node.js with ESM modules (package.json has "type": "module").
- Language: TypeScript with strict compiler settings.
- Frameworks: Hono (HTTP), zod + zod-openapi for schemas.
- API style: REST wrapper around Dahua RPC endpoints.

## Repo Layout
```
src/
├── index.ts              # Entry point (server bootstrap)
├── app.ts                # Hono app setup + middleware
├── openapi.ts            # OpenAPI doc config + Swagger UI
├── dahua-client.ts       # Dahua RPC client and auth flow
├── schemas/
│   ├── index.ts          # Barrel export (re-exports all schemas)
│   ├── common.ts         # ErrorSchema, SessionRequestSchema, etc.
│   ├── auth.ts           # Login/Logout/KeepAlive schemas
│   ├── camera.ts         # Camera-related schemas
│   └── rpc.ts            # RPC and Health schemas
├── routes/
│   ├── index.ts          # Route aggregator (registerRoutes)
│   ├── health.ts         # Health route + handler
│   ├── auth.ts           # Login/Logout/KeepAlive routes + handlers
│   ├── cameras.ts        # Camera routes + handlers
│   └── rpc.ts            # RPC route + handler
└── services/
    ├── session.ts        # Session store (Map wrapper)
    └── camera.ts         # Camera interfaces + parseCameraData
```
- docs/: user-facing API documentation (see docs/README.md).
- dist/: build output (generated by tsc).
- login_poc.py: prototype script (not part of build).

## Build, Run, and Typecheck
- Install deps: `bun install`
- Dev server (tsx): `bun run dev`
- Build (tsc): `bun run build`
- Start built server: `bun run start`
- Typecheck only: `bun run build` (no separate typecheck script).

## Linting and Formatting
- No lint or formatter configured (no eslint/prettier scripts).
- Keep formatting consistent with existing files:
  - 2-space indentation.
  - Semicolons.
  - Double quotes for strings.
  - Trailing commas in multi-line objects/arrays.

## Tests (Current State)
- No test runner or test scripts configured.
- Single-test command: not available until a test runner is added.
- If you add tests, document the command here and prefer:
  - `node --test path/to/test.ts` (Node test runner), or
  - `npx vitest path/to/test.ts` (if adding Vitest), or
  - `npx jest path/to/test.ts` (if adding Jest).

## Environment and Config
- PORT is read from `process.env.PORT` (defaults to 3000).
- Dahua device host is supplied via request payloads.
- No dotenv usage; avoid assuming env files.
- The server uses global `fetch`; prefer Node 18+ runtimes.

## Dependency Management
- Keep dependencies minimal; prefer existing libs.
- Add new deps only when the feature cannot be done with current stack.
- Update `package.json` and `bun.lock` together.
- Avoid adding dev tooling without updating this guide.

## Import Conventions
- Order imports: external packages first, then local modules.
- Group imports by blank lines when mixing external and local.
- Use named imports for library APIs.
- Keep paths relative for local imports (e.g., `./dahua-client`).

## TypeScript and Types
- Strict mode is enabled; avoid implicit `any`.
- Prefer `unknown` over `any` and narrow explicitly.
- Use interfaces for data shapes and public contracts.
- Optional fields are marked with `?:` (see DahuaLoginResponse).
- Public methods can omit explicit return types if obvious, but
  add them when the type is not obvious or is exported.

## Naming Conventions
- Classes: PascalCase (e.g., DahuaClient).
- Interfaces/Types: PascalCase (e.g., DahuaSession).
- Functions/variables: camelCase.
- Zod schemas: PascalCase with `Schema` suffix.
- Boolean helpers: `isX` or `hasX`.

## API and Routing Patterns
- Use `createRoute` + `app.openapi` for all endpoints.
- Keep request/response schemas near route definitions.
- Responses include `success` and `error` fields on failure.
- Stick to existing status code usage: 200/400/401/404/500.
- Keep OpenAPI tags and descriptions up to date.

## Zod/OpenAPI Schema Conventions
- Define schemas with `z.object({...}).openapi("Name")`.
- Include `openapi({ example, description })` on key fields.
- Reuse `ErrorSchema` for failure responses.
- Prefer `z.record(z.string(), z.unknown())` for free-form params.
- Schemas live in `src/schemas/` and are imported via barrel export.

## Response Shape Guidelines
- Success responses include `success: true` and a payload field.
- Failure responses include `success: false` and `error: string`.
- Avoid leaking raw Dahua error objects to clients.
- Preserve consistent JSON keys across endpoints.

## Data Validation
- Use Zod to validate all inputs at route boundaries.
- Enforce non-empty strings with `.min(1)`.
- Validate URLs with `.url()` when a host is required.
- Default optional objects to `{}` in handlers.

## Logging and Observability
- `hono/logger` is already enabled for HTTP requests.
- Do not log credentials or session IDs.
- If adding logs, keep them minimal and structured.
- Prefer `console.log` for dev-only messages.

## Adding New Endpoints (Checklist)
1. Add request/response schemas in appropriate `src/schemas/*.ts` file.
2. Create route file in `src/routes/` with `createRoute` + handler.
3. Export a `register*Routes()` function from the route file.
4. Import and call the register function in `src/routes/index.ts`.
5. Update the health endpoint list if relevant.
6. Update docs in `docs/README.md`.
7. Verify OpenAPI JSON renders in `/doc` and `/swagger`.

## Error Handling
- Wrap handlers in try/catch and return JSON error payloads.
- Use `error instanceof Error ? error.message : "..."`.
- Prefer returning error objects over throwing in route handlers.
- In the client, throw inside private helpers, catch in public APIs.

## HTTP Client Patterns
- DahuaClient uses RPC via `fetch` and JSON bodies.
- Host is normalized (no trailing slash) in constructor.
- Avoid re-creating client per request unless needed.
- Session management is in-memory; note this in docs if changed.

## Comments and Structure
- Use section dividers only for large logical blocks.
- Keep comments short and clarifying, not restating code.
- Prefer doc comments on public or complex methods.

## Documentation Updates
- Update `docs/README.md` when adding or changing endpoints.
- Keep OpenAPI descriptions aligned with behavior.
- Add examples in docs if new fields or flows are introduced.

## Safety and Secrets
- Do not log credentials.
- Avoid storing passwords; keep session IDs only.
- Consider TLS/HTTPS when documenting production usage.

## Cursor/Copilot Rules
- No Cursor rules found in `.cursor/rules/` or `.cursorrules`.
- No Copilot instructions found in `.github/copilot-instructions.md`.

## Tips for Agents
- Run `bun run dev` for local iteration.
- Use `bun run build` before shipping changes.
- Keep changes focused; avoid refactors unless requested.
- If you add lint/test tooling, update this file with commands.
